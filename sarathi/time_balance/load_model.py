from sarathi.time_balance.config import MODEL_CACHE_PATH
from sarathi.time_balance.predict_time import TimePredictor

# (decode_tokens, sum_decode_context_len, batch_request_count, prefill_tokens, prefill_processed_tokens, gpu_mem_used_mb)
CASES = [
    (4,2315,15,242,0,20717.25,3404.9375,16867.11865234375,16962.0),
    (14,2329,15,242,242,20718.75,3403.4375,16867.11865234375,16962.0),
    (5,2529,6,251,0,20719.125,3403.0625,16867.11865234375,16962.0),
    (9,2566,11,247,0,20697.4375,3424.75,16867.11865234375,16962.0),
    (12,2270,14,244,488,20928.375,3193.8125,16867.11865234375,16962.0),
    (13,3005,17,71,10,20928.375,3193.8125,16867.11572265625,16962.0),
    (8,2281,9,248,0,20887.75,3234.4375,16867.11865234375,16962.0),
    (4,1914,7,252,252,21070.0,3052.1875,16867.1181640625,16962.0),
    (10,2008,11,246,127,21070.5625,3051.625,16867.11865234375,16962.0),
    (13,2044,25,243,17,21552.0625,2570.125,16867.11865234375,16962.0),
    (15,2501,18,108,482,21429.0,2693.1875,16867.11572265625,16962.0),
    (6,2902,8,124,9,22612.5625,1509.625,16905.36767578125,16970.0),
]


def main() -> None:
    predictor = TimePredictor.load(MODEL_CACHE_PATH)

    t_ms = [
        predictor.predict(
            decode_tokens=dt,
            sum_decode_context_len=dht,
            batch_request_count=brc,
            prefill_tokens=pt,
            prefill_processed_tokens=ppt,
            gpu_mem_used_mb=gmpt,
            gpu_mem_free_mb=gmft,
            cuda_allocated_mb=cam,
            cuda_reserved_mb=crm
        ).item()
        for (dt, dht, brc, pt, ppt, gmpt, gmft, cam, crm) in CASES
    ]

    print(t_ms)


if __name__ == "__main__":
    main()


# 4,2315,15,242,0,20717.25,3404.9375,16867.11865234375,16962.0,71.35100555419922
# 14,2329,15,242,242,20718.75,3403.4375,16867.11865234375,16962.0,70.9222412109375
# 5,2529,6,251,0,20719.125,3403.0625,16867.11865234375,16962.0,70.04390716552734
# 9,2566,11,247,0,20697.4375,3424.75,16867.11865234375,16962.0,70.16960144042969
# 12,2270,14,244,488,20928.375,3193.8125,16867.11865234375,16962.0,81.90975952148438
# 13,3005,17,71,10,20928.375,3193.8125,16867.11572265625,16962.0,40.9752311706543
# 8,2281,9,248,0,20887.75,3234.4375,16867.11865234375,16962.0,78.37184143066406
# 4,1914,7,252,252,21070.0,3052.1875,16867.1181640625,16962.0,71.104736328125
# 10,2008,11,246,127,21070.5625,3051.625,16867.11865234375,16962.0,72.52774047851562
# 13,2044,25,243,17,21552.0625,2570.125,16867.11865234375,16962.0,78.07683563232422
# 15,2501,18,108,482,21429.0,2693.1875,16867.11572265625,16962.0,38.40614318847656
# 6,2902,8,124,9,22612.5625,1509.625,16905.36767578125,16970.0,61.96326446533203